{
  "project": "S8 Strategic Insights Notebook - Phase 2",
  "branchName": "ralph/s8-notebook-phase2",
  "description": "Enhancements to the S8 strategic insights notebook: token transfer verification, true baseline dates, in-notebook attribution calculation, adjusted ROI, and Part 3 summary section.",
  "userStories": [
    {
      "id": "US-018",
      "title": "Add token transfer verification logic",
      "description": "As an analyst, I need to verify that token inflows match expected grant amounts to catch edge cases where projects received other grants.",
      "acceptanceCriteria": [
        "Add EXPECTED_FIRST_INFLOWS dict with test cases: {'Truemarkets': 70000, 'Super DCA': 30000, '40acres.finance': 200000}",
        "Create function verify_first_inflow(df_token_events, project_name, expected_amount, tolerance=0.02) that returns (is_valid, actual_amount, discrepancy_pct)",
        "Add df_token_transfers_verified DataFrame that flags projects with inflow discrepancies > 2%",
        "For projects with discrepancies, add a 'inflow_warning' column explaining the issue",
        "Log verification results for the three test cases to console output",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Edge case: some projects received audit grants around same time as TVL grants"
    },
    {
      "id": "US-019",
      "title": "Create project_baseline_date with verified inflow logic",
      "description": "As an analyst, I need a 'true' baseline date that uses the minimum of initial_delivery_date and first verified inflow date.",
      "acceptanceCriteria": [
        "Add function get_first_inflow_date(df_token_events, project_name) that returns the timestamp of first inflow",
        "Create 'project_baseline_date' column = MIN(initial_delivery_date, first_inflow_date)",
        "Add 'baseline_date_source' column indicating which date was used ('delivery_date', 'first_inflow', or 'program_start')",
        "Use project_baseline_date for all TVL baseline calculations in df_project_metrics",
        "Add footnote logic for deep dives showing how baseline date was derived",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "The true baseline should be when tokens actually arrived, not just the reported delivery date"
    },
    {
      "id": "US-020",
      "title": "Add attribution calculation function to notebook",
      "description": "As an analyst, I need attribution logic computed in the notebook using assumptions from the joined data.",
      "acceptanceCriteria": [
        "Add OP_PRICE_USD = 0.35 constant (easy to adjust per project later)",
        "Add ATTRIBUTION_BUCKETS = [0.01, 0.02, 0.05, 0.10, 0.20, 0.50, 1.0] constant",
        "Create function calculate_attribution(scope_pct, op_total_usd, coincentives_usd, tvl, attribution_cap_applied) that returns (final_pct, formula_text)",
        "Attribution logic: raw = scope_pct * (op_total_usd / (op_total_usd + coincentives_usd)), apply cap if attribution_cap_applied, round to nearest bucket",
        "Add 'calculated_attribution_pct' and 'calculated_formula' columns to df_project_metrics",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Uses scope_pct, coincentives_usd, attribution_cap_applied from the joined df_grants data"
    },
    {
      "id": "US-021",
      "title": "Update project deep dives with attribution footnote and adjusted ROI",
      "description": "As an analyst, I want the deep dives to show attributed ROI and explain the attribution methodology.",
      "acceptanceCriteria": [
        "Change ROI stat title to 'ROI (TVL change per OP delivered)'",
        "Calculate adjusted_roi = roi * attribution_pct (TVL change attributed to grant)",
        "Display adjusted_roi as the main ROI value in the stat card",
        "Add footnote showing unadjusted ROI: 'Unadjusted: $X/OP'",
        "Update attribution description to show scope, co-incentives context, and cap status",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Main ROI is now the attributed portion; unadjusted is in footnote"
    },
    {
      "id": "US-022",
      "title": "Add Part 3 Summary Section - Tables",
      "description": "As an analyst, I want a summary section with extended project details table and leaderboard.",
      "acceptanceCriteria": [
        "Add Part 3 header: '## Part 3: Summary'",
        "Create extended project details table with columns: Project, Baseline Date, Baseline TVL, TVL Delta, Attribution %, Adjusted ROI",
        "Create leaderboard table sorted descending by Attributable ROI",
        "Use mo.ui.table for both tables with appropriate formatting",
        "Tables display after Part 2 deep dives",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Reuses Part 1 table structure but adds attribution columns"
    },
    {
      "id": "US-023",
      "title": "Add Part 3 Summary Section - Stats widgets",
      "description": "As an analyst, I want summary stats showing program-level metrics with attribution.",
      "acceptanceCriteria": [
        "Add stat widget: 'OP Delivered' showing total OP delivered across all projects",
        "Add stat widget: 'Est. Coincentive Leverage' showing (total coincentives / total OP delivered)",
        "Add stat widget: 'Attributable TVL Inflows' showing sum of (tvl_delta * attribution_pct) for positive deltas",
        "Add stat widget: 'Attributable ROI' showing attributable_tvl_inflows / op_delivered",
        "Use consistent styling with Part 1 stat cards",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Four stats in horizontal row matching Part 1 layout"
    },
    {
      "id": "US-024",
      "title": "Update methodology section with attribution details",
      "description": "As an analyst, I want the methodology to explain the attribution calculation and baseline date logic.",
      "acceptanceCriteria": [
        "Add section explaining 'True Baseline Date' calculation (min of delivery date and first verified inflow)",
        "Add section explaining token transfer verification (expected vs actual inflow amounts)",
        "Add section explaining attribution calculation: scope * incentive_share, with cap tiers",
        "Add section explaining Adjusted ROI = Unadjusted ROI * Attribution %",
        "Document the OP price assumption ($0.35) and how to adjust it",
        "Notebook runs without errors: marimo check s8-strategic-insights.py passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Comprehensive methodology update"
    },
    {
      "id": "US-025",
      "title": "Test and verify notebook end-to-end",
      "description": "As an analyst, I need the notebook to run without warnings or errors.",
      "acceptanceCriteria": [
        "Run marimo check on the notebook - must pass with no errors",
        "Run the notebook with marimo run - must execute without Python errors",
        "Verify all three test cases (Truemarkets, Super DCA, 40acres.finance) show expected inflow amounts",
        "Verify Part 3 tables display correctly with all expected columns",
        "Verify Part 3 stats show reasonable values (not NaN or 0)",
        "Address any deprecation warnings or runtime warnings"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Final verification - notebook must work end-to-end"
    }
  ]
}
