# Ralph Progress Log
Started: Thu Jan 22 08:23:13 EST 2026

## Codebase Patterns
- Use `/Users/cerv1/GitHub/insights/.venv/bin/marimo` for marimo commands (not global marimo)
- Attribution calculation is in `calculate_attribution()` function around line 1211
- ATTRIBUTION_BUCKETS = [0.01, 0.02, 0.05, 0.10, 0.20, 0.50, 1.0]
- OP_PRICE_USD = 0.35 for USD conversions

---

## 2026-01-22 - US-026
- **What was implemented**: Fixed attribution calculation math bug
- **Root cause**: `round_to_bucket()` function was returning 100% (buckets[-1]) for values smaller than the minimum bucket (1%) because the function didn't handle the case where value < buckets[0]
- **Fix applied**: Added check `if value < buckets[0]: return buckets[0]` to handle small values
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `round_to_bucket` function must handle values below the minimum bucket - always check edge cases
  - Test with extreme values (very small, very large) to catch rounding bugs
  - Debug logging is helpful - keep the `[Attribution Debug]` print statements for verification
  - Python operator precedence: `x if condition else y` has lower precedence than `or`, so `A or B if C else D` parses as `A or (B if C else D)`
---

## 2026-01-22 - US-027
- **What was implemented**: Added full attribution formula breakdown in project deep dives
- **Changes made**:
  - Updated `calculate_attribution()` to generate multi-line formula text (newline-separated instead of pipe-separated)
  - Formula now shows explicit labels matching acceptance criteria (e.g., "OP Value / Baseline TVL", "Scope × Incentive Share")
  - Added expandable `<details>` section in deep dive footnotes with "Show calculation details" toggle
  - Formula displayed in monospace font with proper formatting inside expandable section
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `calculate_attribution` returns a tuple of (final_pct, formula_text) - formula is stored in `calculated_formula` column
  - Marimo supports HTML including `<details>` for expandable sections
  - When building multi-line formula text, use `\n` joins and convert to `<br>` for HTML display
---

## 2026-01-22 - US-028
- **What was implemented**: Fixed baseline date logic for undelivered grants
- **Changes made**:
  - Added `_is_undelivered` check: grant is undelivered if `_op_delivered == 0` or `_delivery_date > _latest_date`
  - For undelivered grants, set `_project_baseline_date = _latest_date` (current TVL date)
  - Set `_baseline_date_source = 'undelivered'` to track the source
  - This ensures `baseline_tvl = current_tvl` and `tvl_delta = 0` for projects that haven't received their grant yet
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `_latest_date` (current TVL date) is now calculated earlier in the loop for the undelivered check
  - Undelivered grant detection uses `_op_delivered == 0` as primary check - more reliable than just checking dates
  - `baseline_date_source` values: 'undelivered', 'first_inflow', 'delivery_date', 'program_start'
---

## 2026-01-22 - US-029
- **What was implemented**: Updated deep dive chart annotation to show Baseline Date instead of Grant Delivery
- **Changes made**:
  - Replaced "Grant Delivery" annotation with "Baseline Date (source)" in chart
  - Changed annotation position from `_delivery_date` to `_baseline_date` (the actual date used for calculations)
  - Added `_source_labels` mapping for user-friendly display of baseline_date_source
  - Added handling for 'undelivered' case in baseline footnote text
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The chart annotation uses `_baseline_date` (derived from `_project_baseline_date`) which is set earlier in the loop at line 365
  - Source label mapping: 'first_inflow' → 'first inflow', 'delivery_date' → 'delivery', 'undelivered' → 'not yet delivered', 'program_start' → 'program start'
---

## 2026-01-22 - US-030
- **What was implemented**: Reordered Part 3 summary tables - leaderboard now appears first
- **Changes made**:
  - Modified `_summary_output = mo.vstack([...])` to put leaderboard section before extended details
  - Order is now: "Leaderboard by Attributable ROI" → `_leaderboard_table` → "Extended Project Details" → `_details_table`
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The Part 3 summary tables are created in a single cell around line 710
  - Table ordering is controlled by the `mo.vstack()` call at line 783 - simply reorder the list items
---
