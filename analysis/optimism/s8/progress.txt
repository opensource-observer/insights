# Ralph Progress Log
Started: Thu Jan 22 07:20:02 EST 2026

## Codebase Patterns
- Use `uv run marimo check <file>` to verify notebook syntax
- Token events data uses columns: project_name, block_timestamp, value_op, event_type
- event_type is 'inflow' or 'outflow'
- Projects keyed by 'title' (display name) not 'oso_project_slug'
---

## 2026-01-22 - US-018
- Implemented token transfer verification logic for detecting discrepancies in grant inflows
- Added EXPECTED_FIRST_INFLOWS dict with test cases: Truemarkets (70K), Super DCA (30K), 40acres.finance (200K)
- Created verify_first_inflow() function that returns (is_valid, actual_amount, discrepancy_pct)
- Added df_token_transfers_verified DataFrame with columns: project_name, first_inflow_amount, first_inflow_date, expected_amount, is_valid, discrepancy_pct, inflow_warning
- Console output logs verification status for all test cases
- Files changed: s8-strategic-insights.py
- **Learnings for future iterations:**
  - marimo must be run via `uv run marimo` in this project
  - Token events DataFrame is keyed by project_name which matches 'title' from df_grants
  - The verification cell needs to be placed after fetch_token_events but exports df_token_transfers_verified and verify_first_inflow for downstream use
---

## 2026-01-22 - US-019
- Implemented project_baseline_date calculation using MIN(initial_delivery_date, first_inflow_date)
- Added get_first_inflow_date(df_events, project_name) function that returns timestamp of first inflow
- Added 'project_baseline_date', 'first_inflow_date', and 'baseline_date_source' columns to df_project_metrics
- baseline_date_source tracks which date was used: 'delivery_date', 'first_inflow', or 'program_start'
- Updated TVL baseline calculations to use project_baseline_date instead of delivery_date
- Added footnote to deep dives showing baseline date derivation with comparison to other dates
- Files changed: s8-strategic-insights.py, prd.json
- **Learnings for future iterations:**
  - The project metrics calculation cell needs df_token_events and get_first_inflow_date as dependencies
  - When adding new columns to df_project_metrics, also update the deep dives loop to extract them
  - Footnotes are added via the last mo.md element in the section vstack
---

## 2026-01-22 - US-020
- Added attribution calculation function to compute attribution percentages in the notebook
- Added OP_PRICE_USD = 0.35 constant and ATTRIBUTION_BUCKETS = [0.01, 0.02, 0.05, 0.10, 0.20, 0.50, 1.0] constant
- Created calculate_attribution(scope_pct, op_total_usd, coincentives_usd, tvl, attribution_cap_applied) function
- Attribution logic: raw = scope_pct * (op_total_usd / (op_total_usd + coincentives_usd)), apply cap if specified, round to nearest bucket
- Added 'calculated_attribution_pct' and 'calculated_formula' columns to df_project_metrics
- Also added 'scope_pct', 'coincentives_usd', 'attribution_cap_applied' columns to df_project_metrics for transparency
- Files changed: s8-strategic-insights.py, prd.json
- **Learnings for future iterations:**
  - Attribution data (scope_pct, coincentives_usd, attribution_cap_applied) comes from df_grants which joins with optimism.govfund.s8_attribution
  - The calculate_attribution function needs ATTRIBUTION_BUCKETS as a dependency
  - OP_PRICE_USD is multiplied by op_total_amount to get op_total_usd for the formula
  - The function returns a tuple (final_pct, formula_text) for both the value and human-readable explanation
---

## 2026-01-22 - US-021
- Updated project deep dives with adjusted ROI calculation and attribution footnotes
- Changed ROI stat card title from "ROI ($/OP)" to "ROI (TVL change per OP)"
- Calculate adjusted_roi = roi * attribution_pct (attribution-adjusted TVL change)
- Display adjusted_roi as main value, with unadjusted ROI shown in a small footnote below
- Updated attribution description to show: scope percentage, co-incentives amount, and cap status
- ROI card now shows "Adjusted for X% attribution" with "Unadjusted: $X/OP" footnote
- Files changed: s8-strategic-insights.py, prd.json
- **Learnings for future iterations:**
  - The deep dives loop extracts attribution fields from _row via .get() with defaults
  - ROI color logic should use adjusted_roi (not unadjusted) for consistent positive/negative coloring
  - Attribution description uses pd.notna() to handle potentially missing scope_pct values
---

## 2026-01-22 - US-022
- Added Part 3 Summary Section with two tables after the deep dives
- Created Part 3 header: "## Part 3: Summary"
- Extended project details table with columns: Project, Baseline Date, Baseline TVL, TVL Delta, Attribution %, Adjusted ROI
- Leaderboard table sorted descending by Attributable ROI with columns: Project, OP Delivered, TVL Delta, Attribution %, Attributable ROI
- Both tables use mo.ui.table with consistent formatting
- Fixed marimo branch-expression error by assigning output to _summary_output variable before final expression
- Files changed: s8-strategic-insights.py, prd.json
- **Learnings for future iterations:**
  - marimo cells with if-else branches must assign to a variable and return that variable as the final unnested expression
  - The leaderboard uses 'adjusted_roi' for sorting (roi * attribution_pct)
  - Tables reuse df_project_metrics_with_tvl which already has all the necessary fields from earlier calculations
---
