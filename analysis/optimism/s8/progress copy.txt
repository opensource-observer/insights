# Ralph Progress Log
Started: Thu Jan 22 08:23:13 EST 2026

## Codebase Patterns
- Use `/Users/cerv1/GitHub/insights/.venv/bin/marimo` for marimo commands (not global marimo)
- Attribution calculation is in `calculate_attribution()` function around line 1211
- ATTRIBUTION_BUCKETS = [0.01, 0.02, 0.05, 0.10, 0.20, 0.50, 1.0]
- OP_PRICE_USD = 0.35 for USD conversions

---

## 2026-01-22 - US-026
- **What was implemented**: Fixed attribution calculation math bug
- **Root cause**: `round_to_bucket()` function was returning 100% (buckets[-1]) for values smaller than the minimum bucket (1%) because the function didn't handle the case where value < buckets[0]
- **Fix applied**: Added check `if value < buckets[0]: return buckets[0]` to handle small values
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `round_to_bucket` function must handle values below the minimum bucket - always check edge cases
  - Test with extreme values (very small, very large) to catch rounding bugs
  - Debug logging is helpful - keep the `[Attribution Debug]` print statements for verification
  - Python operator precedence: `x if condition else y` has lower precedence than `or`, so `A or B if C else D` parses as `A or (B if C else D)`
---

## 2026-01-22 - US-027
- **What was implemented**: Added full attribution formula breakdown in project deep dives
- **Changes made**:
  - Updated `calculate_attribution()` to generate multi-line formula text (newline-separated instead of pipe-separated)
  - Formula now shows explicit labels matching acceptance criteria (e.g., "OP Value / Baseline TVL", "Scope × Incentive Share")
  - Added expandable `<details>` section in deep dive footnotes with "Show calculation details" toggle
  - Formula displayed in monospace font with proper formatting inside expandable section
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `calculate_attribution` returns a tuple of (final_pct, formula_text) - formula is stored in `calculated_formula` column
  - Marimo supports HTML including `<details>` for expandable sections
  - When building multi-line formula text, use `\n` joins and convert to `<br>` for HTML display
---

## 2026-01-22 - US-028
- **What was implemented**: Fixed baseline date logic for undelivered grants
- **Changes made**:
  - Added `_is_undelivered` check: grant is undelivered if `_op_delivered == 0` or `_delivery_date > _latest_date`
  - For undelivered grants, set `_project_baseline_date = _latest_date` (current TVL date)
  - Set `_baseline_date_source = 'undelivered'` to track the source
  - This ensures `baseline_tvl = current_tvl` and `tvl_delta = 0` for projects that haven't received their grant yet
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The `_latest_date` (current TVL date) is now calculated earlier in the loop for the undelivered check
  - Undelivered grant detection uses `_op_delivered == 0` as primary check - more reliable than just checking dates
  - `baseline_date_source` values: 'undelivered', 'first_inflow', 'delivery_date', 'program_start'
---

## 2026-01-22 - US-029
- **What was implemented**: Updated deep dive chart annotation to show Baseline Date instead of Grant Delivery
- **Changes made**:
  - Replaced "Grant Delivery" annotation with "Baseline Date (source)" in chart
  - Changed annotation position from `_delivery_date` to `_baseline_date` (the actual date used for calculations)
  - Added `_source_labels` mapping for user-friendly display of baseline_date_source
  - Added handling for 'undelivered' case in baseline footnote text
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The chart annotation uses `_baseline_date` (derived from `_project_baseline_date`) which is set earlier in the loop at line 365
  - Source label mapping: 'first_inflow' → 'first inflow', 'delivery_date' → 'delivery', 'undelivered' → 'not yet delivered', 'program_start' → 'program start'
---

## 2026-01-22 - US-030
- **What was implemented**: Reordered Part 3 summary tables - leaderboard now appears first
- **Changes made**:
  - Modified `_summary_output = mo.vstack([...])` to put leaderboard section before extended details
  - Order is now: "Leaderboard by Attributable ROI" → `_leaderboard_table` → "Extended Project Details" → `_details_table`
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The Part 3 summary tables are created in a single cell around line 710
  - Table ordering is controlled by the `mo.vstack()` call at line 783 - simply reorder the list items
---

## 2026-01-22 - US-031
- **What was implemented**: Updated extended project details table with new column structure
- **Changes made**:
  - Added `OP_PRICE_USD` to cell dependencies for grant USD calculation
  - Added `grant_usd` calculation: `op_total * OP_PRICE_USD`
  - Added `leverage` calculation: `coincentives_usd / grant_usd`
  - Created `_format_currency()` helper for consistent formatting ($1.2M, $45K patterns)
  - Added Current TVL column
  - Added Co-incentives (USD), Grant (USD), and Leverage columns
  - Removed Attribution % and Adjusted ROI columns (those remain in leaderboard only)
  - Dates formatted as YYYY-MM-DD
- **Files changed**: s8-strategic-insights.py
- **Learnings for future iterations:**
  - The extended details table is separate from the leaderboard - leaderboard has attribution metrics, extended details has financial inputs
  - Currency formatting helper `_format_currency` uses M/K suffixes based on magnitude
  - Leverage is formatted as `X.Xx` (e.g., "2.5x") to clearly indicate it's a ratio
  - Cell dependencies must include any constants used (e.g., `OP_PRICE_USD`)
---

## 2026-01-22 - US-032
- **What was implemented**: End-to-end verification of all Phase 3 fixes
- **Verification results**:
  1. `marimo check s8-strategic-insights.py` passes with no errors
  2. PancakeSwap attribution: Fixed - `round_to_bucket()` now handles values < minimum bucket correctly (line 1324-1325)
  3. Attribution footnote: Full formula breakdown in expandable details section (lines 1340-1366)
  4. Undelivered grants: Baseline date set to current date when `_is_undelivered=True` (lines 1761-1773)
  5. Deep dives: "Baseline Date (source)" annotation replaces "Grant Delivery" (lines 503-510)
  6. Part 3 tables: Leaderboard appears before extended details (lines 809-814)
  7. Extended details columns: Project, Baseline Date, Baseline TVL, Current TVL, TVL Delta, Co-incentives (USD), Grant (USD), Leverage (lines 762-767)
- **Files changed**: prd.json (marked US-032 as passing)
- **Learnings for future iterations:**
  - All fixes from US-026 through US-031 work together correctly
  - Phase 3 complete - all 7 user stories now pass
---

## 2026-01-22 - Code Cleanup for Public Release
- **What was implemented**: Cleaned up notebook for public release
- **Changes made**:
  1. Removed `[Attribution Debug]` print statements from `calculate_attribution()` function (lines 1413-1414)
  2. Removed token transfer verification print statements (lines 1540-1545)
  3. Removed `EXPECTED_FIRST_INFLOWS` test data constant (entire cell deleted)
  4. Removed unused `import plotly.express as px` import
  5. Moved hardcoded `6_300_000` to config constant `TOTAL_APPROVED_OP`
  6. Updated summary tables cell to use the constant
  7. Cleaned up extra blank lines from deleted cell
- **Files changed**: s8-strategic-insights.py
- **Verification**: `marimo check` passes
- **Learnings for future iterations:**
  - Debug print statements should be removed before public release
  - Hardcoded values should be consolidated in config cell with descriptive names
  - Test/verification data can be useful during development but should be removed or documented for production
---
